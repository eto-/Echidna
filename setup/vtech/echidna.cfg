# Borexino reconstruction program (echidna)
# configuration file
# module list to be run by the Borexino framework
# users should not modify this file,
# a user file echidna.cfg is provided to overwrite parameters
# in addition command line options are enabled and thier use is encouraged
# check echidna -h

# For module developers: if you want to add a module, 
# please respect the following syntax
# FILE FORMAT:
# 
#<module example>
# priority 1
# enable 1
# par1 value 
# par2 2
#<end>    




#######################
# named (utility classes)
<named laben_time_hit>
<end>

<named laben_charge_hit>
baseline_fast_drift 7
zero_charge_limit -1		# Always contribute to npe with at least 1
<end>

<named detector_interface>
laben 1
muon 1
mctruth 1
disable_lg { 32 }		# disabled channels { 123, 11, 99 }
#disabled_laben_channel_properties { user, db, bad_precalib, empty, disconnected, bad_pmt_timing, dead_in_neutrino, dead_in_raw, bad_elec_timing, hot_in_neutrino, low_gain, high_gain}
disabled_laben_channel_properties { user, db, bad_precalib, empty, disconnected, bad_pmt_timing, dead_in_neutrino, dead_in_raw, bad_elec_timing, hot_in_neutrino, low_gain, high_gain, hot_pmt}
                                # disable laben lg with that properties
                                # Possible values are:
				#   user: use disable_lg hand specified channels
				#   db: from "DisabledChannels" table (disables detector_monitor if db is filled)
                                #   bad_precalib: bad or no precalibrations
				#   empty: empty channel (from bx_geometry)
				#   disconnected: pmt is disconnected
                                #   bad_pmt_timing: bad timing calib for pmt
                                #   dead_pmt: dead pmt
                                #   very_hot_pmt: > 50kHz (not yet implemented)
                                #   bad_elec_timing: problem in the timing of the electronic channel 
                                #   hot_in_laser: hot channel in laser events
                                #   hot_in_neutrino: hot channel in neutrino events
				#   low_eff_in_neutrino: low efficency channel in neutrino events
				#   dead_in_neutrino: dead channel in neutrino events (but not dead_pmt)
				#   dead_in_raw: dead channel in neutrino raw hits    
disabled_muon_channel_properties { user, empty, disconnected, dead_in_neutrino}
                                # disable laben lg with that properties
                                # Possible values are:
				#   user: use disable_lg hand specified channels
				#   empty: empty channel (from bx_geometry)
				#   disconnected: pmt is disconnected
                                #   hot_in_laser: hot channel in laser events
                                #   hot_in_neutrino: hot channel in neutrino events
                                #   hot_in_muon: hot channel in muon events
				#   low_eff_in_neutrino: low efficency channel in neutrino events
				#   low_eff_in_muon: low efficency channel in muon events
				#   dead_in_neutrino: dead channel in neutrino events (but not dead_pmt)
				#   dead_in_muon: dead channel in muon events (but not dead_pmt)
scaling_factor 1		# For simulation: disable channels event by event with (event /= scaling_factor)
<end>

<named flight_path>
create_histo 0			# do not fill debugging histograms
refidx 0			# Refraction index: <=0 use database default, else use this value (may be overwritten by mofules)
<end>

<named bx_reco_framework>
max_events -1			# maximun number of events to process (-1 unlimited)
skip_events 0			# skip the first n events
precalib_events	1000		# number of events to use for precalibrations (has to be > 0)
do_precalib 0			# by default do not do the precalibrations
redo_precalib 0			# if 1 force precalib recalculations if already present in DB
ignore_precalib_absence 0	# do not change (else decoders will break)
require_electronics_calibrations 1 # require electronics calibrations data
<end>

<named barn_interface>
write_histos 1			# write histograms
write_barn 1			# write barn
network_send 0			# send to network
network_address localhost	# address where to send object (numerical address or host name)
network_port 7001		# port where to send object 
<end>

<named bx_dbi>
SERVER1 bxdb.lngs.infn.it	# main postgres server
SERVER2 bxdb.lngs.infn.it	# secondary postgres server
PORT1 5432			# main data base listening port
PORT2 5432			# secondary data base listening port
PGUSER borex_guest		# postgres user name
#PGPASSWD xyz			# postgreSQL password (uncomment only if needed)
DAQCONFIGDBNAME daq_config	# name of the daq_config database
BXGEOMETRYDBNAME bx_geometry	# name of the bx_geometry database
BXCALIBDBNAME bx_calib		# name of the bx_calib database
BXPHYSICSDBNAME bx_physics	# name of the bx_physics database
BXSLOWDBNAME bx_slow		# name of the bx_slow database
CHHISTORYDBNAME channelhistory  # name of the channelhistory database
BXPRECALIBDBNAME bx_precalib	# name of the bx_precalib database
full_connect 0			# connect either to bxslow and channelhistory dbs
write_enabled 1			# database writable
force_write 0			# force write even if not production user
disabled_channel_cycle 0	# read disabled channels from specified cycle (0 is current cycle)
<end>

########################
# role = reader

<module bx_reader>
priority 10
enable 1
file_url file://Run001610_01.out.gz
repository_url /data/borexino/
wget_command wget -nv --timeout=60 -O - 
max_pool_size 10000000		# internal pool size max dimension in bytes
pool_max_event_count 1500	# internal pool size max number of events
pool_readhaed_step 30		# how many evets to read in read haed of the pool
<end>



########################
# role = precalib_cycle*

<module bx_precalib_laben_adc>		# cycle 1
priority 10
enable 1
maxima_bin_add 2			# Shift from local maxima to real histogram limits
<end>

<module bx_precalib_laben_gray>		#cicle 1
priority 20
enable 1
channel_reference_skip 158		# When calculating shift candidate refence channel every channel_reference_skip. 
					# Do not use a low value (< 50) since it take a lot of memory (>60MB) and a lot of CPU (40s)
mean_bound 5				# Limits on the mean and rms for a candidate reference channel
rms_bound 20
<end>

<module bx_precalib_laben_phases>	# cycle 2
priority 10
enable 1
<end>

<module bx_precalib_laben_d80>		# cycle 3
priority 10
enable 1
d80_low_limit 65.			# the limits for valid d80 values (else 80. value is used)
d80_high_limit 95.
<end>

<module bx_precalib_laben_check_tdc>	# cycle 4
priority 10
enable 0
ref_channel 900				# Reference channel used for time diffs.
time_distrib_max_mean 2.5		# The maximun deviation from 0 for the average time difference of the hits
time_distrib_max_rms 5			# The maximun RMS of time difference of the hits
write_precalib 0
<end>

<module bx_precalib_muon_findpulse>	# cycle 1
priority 10
enable 1                                # keep it enabled just for histo, but unused by other modules.
use_mode 0                              # Uses mode of distribution instead of mean (default). May work better on noisy runs.
<end>

<module bx_precalib_muon_pedestals>	# cycle 2
priority 10
enable 1
min_evnum                501 #first event when pedestal is issued by daq
max_evnum                999 #last  event when pedestal is issued by daq
precalib_pulse_tolerance 150 #tdc ticks (either units)
min_pedestal_width       610 #tdc ticks old 1.04ns units
max_pedestal_width       900 #tdc ticks old 1.04ns units
min_new_pedestal_width   790 #tdc ticks new 0.8ns units
max_new_pedestal_width  1170 #tdc ticks new 0.8ns units
use_fixed_time             1 #if set, the result of find_pulse is ignored. fixed_pulse_time below is used instead.
fixed_pulse_time       11230 #tdc ticks. old 1.04ns ticks. back from common stop. 
			     # It changed according to trgsetup, check value run by run if used.
fixed_new_pulse_time    9324 #tdc ticks. new 0.8ns. from gate start.
write_precalib             0
<end>

<module bx_precalib_muon_gate>	# cycle 3
priority 10
enable 1
min_evnum                001 #first event when gate is issued by daq
max_evnum                499 #last  event when gate is issued by daq
precalib_pulse_tolerance 150 #tdc ticks (either units)
min_gate_width            40 #tdc ticks
max_gate_width           200 #tdc ticks
min_new_gate_width        50 #tdc ticks
max_new_gate_width       260 #tdc ticks
use_fixed_time             1 #if set, the result of find_pulse is ignored. fixed_pulse_time below is used instead.
fixed_pulse_time       11230 #tdc ticks. old 1.04ns ticks. back from common stop. 
			     # It changed according to trgsetup, check value run by run if used.
fixed_new_pulse_time    9324 #tdc ticks. new 0.8ns. from gate start.
write_precalib             0
<end>



########################
# role = main_loop

<module bx_laben_raw_validator>
priority 10
enable 1
<end>

<module bx_trigger_decoder>
priority 100
enable 1
<end>

<module bx_filter_trigger>
priority 101			# The first after trigger decoder
enable 1
skip_trigger_types {}		# The list of trigger types to skip in a vector; possible values are:
				# neutrino, muon, neutron, laser266, laser355, laser394, pulser, random
				# Example { laser394, pulser, random }
<end>

<module bx_laben_decoder>
priority 110			# HAS TO BE BIGGER THAN bx_trigger_decoder
enable 1
discard_out_of_gate_hits 1	# do not copy out of gate hits
discard_reference_hits 1	# do not copy hits from reference channels
discard_calib_data 0		# do not use fine calibration data for the channels
discard_retrigger_hits 0	# do not copy the retrigger hits
discard_reflection_hits 0	# do not copy reflection hits
discard_disabled_lg 1		# do not copy hits from disabled channes (from bx_detector) 
warn_empy_channel 0		# print an error for hits on empty channels
mc_use_charge_calib_data 1	# for montecarlo, use fine calibration data for the channels 
nhits_threshold 0		# ignore low energy events
<end>

<module bx_muon_decoder>
priority 120
enable 1
discard_disabled_lg 1           # do not copy hits from disabled channes (from bx_detector)
apply_calibration   1           # apply time alignmenet and charge conevrsion (tdc ticks -> pe)
<end>

# >= 150 decoded

<module bx_calib_laben_crate_delay>
priority 150
enable 0
<end>

<module bx_calib_gate>
priority 150
db_write 0
enable 0
<end>

<module bx_calib_fiber_bundle>
priority 150
enable 0
laser_low 640
laser_high 670
dark_low -1500
dark_high -500
<end>

<module bx_calib_laser_transparency>
priority 150
enable 0
refidx 1.
time_calib_events 1000
delay 598       #0 for simulation 588 for radial data 598 for oblique data
type 2          #1 for radial beam, 2 for oblique beam
patch_panel 1   #1-12 for radial beam 1-19 for oblique
threshold 0.02  #paremeters for TSpectrum search: threshold is defined as this number(0.02) * max bin content
peak_width 3.   #typical RMS for expected peaks
resolution 1    #with 1 finds peak at least one peak_width separated
<end>

<module bx_calib_laben_time_align>
priority 150
enable 0
write_calib 0   # enable DB update
large_drift 0   # discard calib data in case of large variations
<end>

<module bx_calib_laben_charge_peak>
priority 150
enable 0
write_calib 0   # enable DB update
large_drift 0   # discard calib data in case of large variations
<end>

<module bx_calib_muon_time_align>
priority 150
enable 0
write_calib_time   0 # enable DB update
large_drift        1 # discard calib data in case of large variations
update_threshold   0.6 # fraction of good channels required to actually update DB
minimum_efficiency .001 # minimum efficiency required for calib
time_allowance    10. # half width of the time fit range (ns)
max_time_offset   20.  # allowed displacement from avg, was at 5
min_time_rms      0.  # minumum rms required
max_time_rms      10.  # maximum rms required, was at 5
time_drift        10. # allowed drift from previous calib
<end>

<module bx_calib_muon_charge_peak>
priority 151
enable 0
write_calib_charge 0 # enable DB update
large_drift        1 # discard calib data in case of large variations
update_threshold   0.6 # fraction of good channels required to actually update DB
minimum_efficiency .001 # minimum efficiency required for calibi
time_offset       717 # offset of the led pulse from gate start (ns)
time_allowance    40. # half width of the time fit range (ns)
max_charge_offset 30. # allowed displacement from avg
min_charge_rms    0.  # minumum rms required, was at 1
max_charge_rms    13. # maximum rms required
charge_drift      5. # allowed drift from previous calib
chi2_max	  4. # maximum allowed reduced chi2 value for charge fits
chi2_min          0.1 # minimum ...
<end>


<module bx_detector_monitor>
priority 150
enable 1
calibration_mode  1  # to search for lg which are getting off during the run 
disabling_lg  1 # if the found off channels should be disabled in decoder 
db_write      1 #write disabled channels to  "ChannelsDisabledDuringRun" table, if not already present
n_events 100     #after how many events to analyse       
n_rms     6      #rms deviation of hot boards
first_time_hot 0 #to warn / or not if module is found hot in the fisrt cycle od n_events
n_cycles  15     #warning is done when problem is done fisrt time and then again when 1x(n_cycles)th, 2x(n_cycles)th time etc  
<end>

<module bx_calib_laben_electronics>
priority 150
enable 0
db_write 0                       # write to DB  
check_reference_lg      0        # to check trigger and laser ref channels (enable also hits from these lg by setting discard_reference_hits to 0)
good_hits_fraction      0.95     # to warn for lg having (Ndecoded_hits  < good_hits_fraction * Nraw_hits)
dead_channel_thresh     0.05     # if lg has less hits (fraction from mean value among lg), considered dead 
low_eff_thresh_l_n      0.2      # fraction from mean, neutrino and laser triggers
low_eff_thresh_p        0.2      # fraction from mean, pulser triggers
hot_thresh_l_n          10        # N of sigma above mean, neutrino and laser triggers 
hot_thresh_p            5        # N of sigma above mean, pulsertriggers 
retriggering_thresh     0.1     # for 140 - 200 ns zone after the first hit, fraction from the total hits in the same lg/trigegr_type
zero_thresh             0.1      # for base, peak, charge = peak - base: zero_value / n_pulser_triggers
0xFF_thresh             0.1      # for base and peak: FF_ADC_value / n_pulser_triggers
too_spread_thresh       0.95     # fraction of hits to be within +- 20 channels around max bin   
negative_charge_thresh  0.1      # (charge < 0) / n_pulser_triggers
mean_offset             10.      # allowed offset of the base, peak, charge from mean (in ADC channels)
rms_ADC                 5.       # allowed rms for base and peak in single lg (pulser triggers)
rms_charge              2.5      # allowed rms for charge = peak - base in single lg (pulser triggers)
Nlg_status_change       10       # how many lg could change status (for each condition separately) without having a global warning
<end>

<module bx_calib_muon_electronics>
priority 150
enable 0
db_write 0                       # write to DB  
dead_channel_thresh     0.05     # if lg has less hits (fraction from mean value among mch), considered dead 
low_eff_thresh          0.2      # fraction from mean
hot_thresh              5        # N of sigma above mean
retriggering_thresh     0.1      # fraction from the total hits in the same lg/trigegr_type
nch_status_change       5        # how many lg could change status (for each condition separately) without having a global warning
<end>

<module bx_calib_laben_decoding>
priority 150		
enable 0
monitor_mode       0            # do check after 1000 precalib events
db_write           0            # write to the database 
limit_nlg_precalib_not_ok 300   # warning if more than this limit channels have precalib failed  
check_reference_lg 0		# to check trigger and laser reference channels (enable also hits from these lg by setting discard_reference_hits to 0)
mean_limit_single 4.5		# in ns, how can be shifted precalib peak from 0 for 1 channel
rms_limit_single 3
mean_limit_total 1.0		# for sum of all logical channels
rms_limit_total 1.7
<end>

<module bx_laben_findcluster>
priority 200
enable 1
start_threshold 8		# The number of hits in 48ns for a cluster rought start: 10 -> 50keV
neutron_start_threshold 60	# The number of hits in 48ns for a cluster rought start
count_threshold 15		# The threshold for the total energy of the cluster: 20 -> 50keV
he_threshold 800		# The number of hits to use he (high energy) parameters: 800 -> 1.3 MeV
ripple_bins 8			# Ripple start when in ripple_bins (16n) there are hits compatible with dark rate (never bigger than 20!!!)
he_ripple_bins 14		# Ripple start when in ripple_bins (16n) there are hits compatible with dark rate (never bigger than 20!!!)
tail_bins 15			# Delay cluster end of tail_bins (16ns/bin) in case no cluster is found inside the tail_bins window
long_bins 96			# Define a long cluster (for m4), 0 to disable
force_one_large_cluster	0	# Create a large cluster up to the end of the gate. This option is usefull only to test the splitting
strict_gate 0			# Search clusters strictly in the gate
mach4_cluster 0			# Use Mach4 clustering algorithm.
<end>

<module bx_muon_findcluster>
priority 200
enable 1
bin_width       50              # Width (ns) of the binned distribution
start_threshold 4		# The number of hits in 3bins for a cluster rougth start
count_threshold 6		# The threshold for the total nhits of both clusters
ripple_count    4			# Ripple start when no more than ripple_count hits are found in a dark rate dependent window
enable_histos   0 		# enable some histograms
mincharge       2.0              # Minimum charge for a cluster to be saved (pe)
maxdt          20.		# Cluster definition: max dt between 2 hits (ns).
maxdr_sss       3.		# Cluster definition: max dr between 2 hits (m), if cluster on sss.
maxdr_floor     4.5		# Cluster definition: max dr between 2 hits (m), if cluster on floor.
hit_charge_threshold .25         # minimum charge a hit has to have to be clustered
max_hits_sss     3		# Max nhits used to compute cluster center and charge, if cluster on sss.
max_hits_floor   4		# Max nhits used to compute cluster center and charge, if cluster on floor.
tau             20              # time constant used to weight hits to compute cluster center (ns).
split_minimum_hits 10           # Cluster splitting: minimum hits required
wimp_fraction   .67		# Cluster splitting: fraction of hits to be excluded from search for maxima.
split_separation .5		# Cluster splitting: separation point in nhits for search of maxima.
split_window    10              # Cluster splitting: max dt to start/stop cluster time in search for maxima (ns).
ds_splitting    3.5		# Cluster splitting: min ds between maxima to confirm splitting (m)
dt_splitting    10		# Cluster splitting: min dt between maxima to confirm splitting (ns)
<end>

# >= 250 clustered

<module bx_calib_laben_retrigger>
priority 300                   # run always at the uppest level of reconstruction
enable 0
n_sigma  2                     # how many sigma away has to be the ratio bad/good hits for an lg to be considered bad
factor   4                     # n_retrigged_hits_in_bad_lg > factor * mean_n_retrigged_hits
<end>

<module bx_calib_laben_dark_rates>
priority 300
enable 0
db_write                    0            # write to the database 
min_dark_time               0.05   # in seconds; minimal time within which dark hits are observed
dark_rate_thresh_high       10     # in kHz, upper threshold, above is an hot PMT 
dark_rate_thresh_low        0.1    # in kHz, lower threshold
			           # Nhits_expected = measured_dark_time * (dark_rate_thresh_low * 1000)  
				   # if Nhits_measured_in_lg < (Nhits_expected - 6 * sqrt(Nhits_expected)) -> PMT is dead 
index_trg_type              1111   # which trigger types to be used in dark rate calculation
			           # orders of magntitudes (1000 -> 1): random, pulser, laser, 1-cluster neutrino
rate_diff                   0.1    # allowed difference of mean dark rate from diffent trigger types  
<end>

<module bx_calib_laben_charge_tt1>
priority 300
enable 0
db_write 0   # enable DB update =1, ==2 force writing to DB  
min_trig 50000 # min number of events with all cuts to write to DB (100000 triggers ~ 75 000 with cuts  ~ 2000 mean entries)
<end>

<module bx_calib_muon_pulser>
priority 150
enable 0
db_write 0                       # write to DB
<end>

<module bx_calib_muon_alignment>
priority 150
enable 0
db_write 0                       # write to DB
nhits_thresh 180		 # threshold for nhits for a pulser event, below 'misaligned'
nmis_thresh  3			 # maximally tolerated number of subsequent misaligned events 
<end>

<module bx_calib_muon_dark_rates>
priority 300
enable 0
db_write                    0      # write to the database
min_statistics              50000  # in events;
gate_start                 -8000   # ns 
gate_end                   -1000   # ns
dark_rate_thresh_high       30     # in kHz, upper threshold, above is a hot PMT
dark_rate_thresh_low        0.1    # in kHz, lower threshold, below is a dead PMT
<end>

<module bx_baricentrator>
priority 300
enable 1
first_hits_gate 40		# Use only hits with time lesser than this value (in ns)
mean_algorithm T		# Several algorithms are defined "Q", "T", "QT" 
Q_normalization 1.9		# Normalization value for Q
T_normalization 50.		# Normalization value for T
T_filter_time 42.		# Constant time (close to the event time) for T
QT_normalization 1.9		# Normalization value for QT
QT_filter_time 20.		# Constant time (close to the event time) for QT
refidx 0			# Refraction index: <=0 use database default, else use this value (passed to flight_path)
<end>

<module bx_position_reco_mi>
priority 310
enable 1
keep_ratio 10			# skip # events of 100 (-1 to disable)
tmax	4000.			# Max time of photons included in reconstruction
refidx 1.7			# Refraction index: <=0 use database default, else use this value
<end>

<module bx_position_reco_lngs>

priority 310
enable 1
tmax	4000.			# Max time of photons included in reconstruction
refidx 1.68			# Refraction index: <=0 use database default, else use this value
<end>

<module bx_position_reco_msk>
priority 310
enable 0
landau_mpv 8			# Most Probable Value for Landau pdf
landau_sigma 15			# Sigma for Landau pdf
time_cut 42.0			# Time cut not to work with scattered photons [ns]
<end>

<module bx_position_reco_dbn>
priority 310
enable 0
first_hits_gate 40		# Use only hits with time lower than this value (in ns)
gauss_sigma { 0.6, 0.8, 1.0, 1.2, 1.4 } # PDF parameter, gaussian sigma at different shells (see code)
t0_shift { -2.8, -3.0, -3.2, -3.4, -3.6 } # Correction to t0 got from (R - r_bar)/c (somehow parent to pdf mean value)
use_grad 1			# Use analithic gradiend in minimization
refidx 0			# Refraction index: <=0 use database default, else use this value (passed to flight_path)
<end>

<module bx_position_reco_mach4>
priority 310
enable 0
refidx 1.7
<end>

<module bx_position_reco>
priority 340			# Has to be bigger than any other position reco
enable 1
position_algorithm lngs	        # Choose the algorithm in use, possible values are baricenter, milano, moscow, dubna and mctruth and fixed
refidx 1.7			# Refraction index: <=0 use database default, else use this value (passed to flight_path)
fixed_position	{ 0, 0, 0 }	# X:Y:X position for fixed position algorithm
<end>

<module bx_laben_energy_tracker>
priority              350
enable                  1
enable_histos           0
tau                    20.      # Weight
time_limit              5.      # Consider only the first hits within the beginning of the run
<end>

<module bx_laben_tof_tracker>
priority              360
enable                  1
enable_histos           0
<end>

<module bx_muon_tracker>
priority              350
enable                  1
enable_histos           0
tau                    20	 # time constant for clustering
hit_charge_threshold   .1  # minimum charge for hit to be considered as "cluster"
entry_tau              2.5  # suppresion of "late" entry points
entry_mean            -45.  # optimal dt of entry point relative to ID, no longer used, hardcoded now
entry_sigma            10.  # sigma for optimal time of entry point
exit_incline            3.529 # distance-to-time correlation
exit_sigma             .25 # sigma for optimal time difference
exit_dt_min            10. # minimal distance in time between entry and exit point
<end>

<module bx_cmt_tracker>
priority              360
enable                  0
enable_histos           0
<end>

<module bx_global_tracker>
priority              370
enable                  1
enable_histos           0
max_dev                 5.      # maximum inclination w/o rotation needed
omega                  45.      # rotation angle
chi2max44               3.      # maximum reduced chi2 value allowed to keep track with 4 points
max_par             10000.      # maximum the fit parameters are allowed to have
<end>

# >= 370 space reconstructed

<module bx_splitting_filter>
priority 380
enable 1
window_width 2048		# A power of 2 and bigger than 1024
zero_bin 256			# > * sample_width and << window_width / 2
sample_ramp_lenght 4		# The linear part in the sample 
sample_exp_tao	20		# The tao of the sample exponential
sample_width 120		# Fixed by sample_ramp_lenght and sample_exp_tao; exp ((sample_ramp_lenght - sample_width) / sample_exp_tao) < 0.005
peak_charge_threshold 10	# The minimum energy of a peak expressed as hits in sample_width
peak_time_threshold 4		# The minimum time duration (ns) of a peak after sample convolution
peak_mode tspectrum_highres	# Peak finding algorithm:
				#	- tspectrum_simple: use TSpectrum::Search ()
				# 	- tspectrum_highres: use TSpectrum::Search1HighRes ()
<end>

<module bx_energy_reco_mc>
priority 400			# Has to be bigger than any position reco
enable 0
<end>

<module bx_energy_reco_lik>
priority 400
enable 0
<end>

<module bx_energy_reco_dbn>
priority 400
enable 0
<end>

<module bx_energy_reco_msk>
priority 400
enable 1
attenuation_length 36.0		# Attenuation length for PC [m]
refidx 1.53			# Refraction index: <=0 use database default, else use this value (passed to flight_path)
cathode_efficiency 0.25		# Averaged photocathode quantum efficiency
coef_to_return_npe_cone 0.000284	# cathode_eff*omega*att_factor for photon came from (0,0,0), pmt with cone
coef_to_return_npe_nocone 0.000095	# cathode_eff*omega*att_factor for photon came from (0,0,0), pmt without cone
<end>

# this module handles new data based on CAEN V1731 boards
# (Genova system for neutron detection and possibily supernova)
<module bx_v1731sys>
priority 450
enable 0
skip_after_run8504 1  #cycle 11: due to a hardware problem in sept08, some run have to b skipped
<end>

<module bx_pid_alphabeta>
priority 500
enable 1
alphabeta_file_path ./particleid/data/     # path where alpha/beta files should be searched for
minimum_cluster_size 30                    # clusters with nhits below this value are ignored for alpha/beta
<end>

<module bx_pid_positron>
priority 500
enable 1
shapes_file ./particleid/data/positron_shapes.root     	# path where positron/electron files should be searched for
nnhits_min 350						# skip events with normalized hits < of this value
nnhits_max 725						# skip events with normalized hits > of this value
smear_ops 5
smear_nops 5
smear_c11 15
smear_beta 20
sum_min 0.005
time_max 400
<end>


<module bx_pid_shape>
priority 500
enable 1
event_debug 0                   # to print out details about suspicious event
min_nhits  0                    # minimal number of hits in cluster in order to be processed
nbins	10			# Number of bins to use when discretizing theta and phi in the spherical harmonics
<end>

<module bx_pid_ab_mach4>
priority 500
enable 0
shapes_file ./particleid/data/mach4_shapes.root
skip_gatti_filter 0
<end>

<module bx_omon>
priority 800			# run always the last
enable 0
path /bxwww/data/		# export files location
law 1				# export law: 
				# 0-no export, 
				# 1-on events, 
				# 2-on echidna runtime, 
				# 3-on data timestamp; 
				# 4-combined
after_e 300			# export after every xxx events
after_t 60			# export after every yyy seconds of running echidna
<end>

<module bx_calib_monitor>
priority 1000                   # run always at the uppest level of reconstruction
time_interval 50		
enable 0
<end>

<module bx_snews>
priority 1000
enable 0
connect_brain 1
<end>

<module bx_test_module>
priority 1000                   # run always at the uppest level of reconstruction
my_sample_parameter 1
write_my_calib 0
enable 0
<end>


#######################
# role = writer

<module bx_writer>
priority 999999
enable                1
file_name             auto # (auto=RunXXXXXX.root)
file_overwrite        1 #(bool)
directory             ./ # string
buffer_size           64000
splitting_level       99
write_tree            1 #(bool)
write_laben_raw       0 #(bool)
write_laben_decoded   1 #(bool)
write_laben_clustered 1 #(int ) 0=no 1=clusters  2=clusters&hits
write_laben_rec       1 #(int ) 0=no 1=clusters  2=clusters&hits
write_muon_raw        1 #(bool)
write_muon_decoded    1 #(bool)
write_muon_clustered  1 #(bool)
write_mctruth         2 #(int ) 0=no 1=frames    2=frames&hits
write_barn            1 #(bool) root barn histograms, not in tree
<end>

#######################
# CONFIGURATIONS
<config default>
<end>

<config low_level>
# config to be included in other configs
# to disable high level modules (from clustering level on)
bx_laben_findcluster.enable 0
bx_baricentrator.enable     0
bx_position_reco.enable     0
bx_position_reco_mi.enable  0
bx_position_reco_lngs.enable  0
bx_position_reco_dbn.enable 0
bx_position_reco_msk.enable 0
bx_energy_reco_dbn.enable   0
bx_energy_reco_lik.enable   0
bx_energy_reco_mc.enable    0
bx_energy_reco_msk.enable   0
bx_splitting_filter.enable  0
bx_pid_shape.enable         0
bx_pid_alphabeta.enable     0
bx_pid_positron.enable      0
bx_laben_energy_tracker.enable 0
bx_laben_tof_tracker.enable    0
bx_muon_findcluster.enable  0
bx_muon_tracker.enable      0
bx_global_tracker.enable    0
bx_v1731sys.enable          0
#bx_muon_iv.enable 0 # no stanza for this module?
<end>

<config precalibrations>	                      # Calculate and store precalib
# do precalib and 1500 events
bx_reco_framework.do_precalib                         1
bx_reco_framework.max_events                          1500
bx_reco_framework.require_electronics_calibrations    0
# laben precalib
bx_precalib_laben_check_tdc.write_precalib            1
bx_laben_decoder.discard_reference_hits               0 # Do not skip reference channels
detector_interface.disabled_laben_channel_properties  {}  # Imperative else bad channels will be skipped
detector_interface.disabled_muon_channel_properties {}
bx_calib_laben_decoding.enable                        1 
bx_calib_laben_decoding.check_reference_lg            1 # Precalib reference channels too
bx_calib_laben_decoding.db_write                      1 
# muon precalib
bx_precalib_muon_pedestals.write_precalib             1

# disable everything
bx_detector_monitor.enable                            0
bx_muon_decoder.enable                                0
<include low_level>                                     # disables all high level modules
bx_writer.write_tree                                  0 # we write barn only 
<end>

<config electronics_calibrations>		      # Calibrate electronic channels
bx_reco_framework.require_electronics_calibrations    0
bx_laben_decoder.discard_reference_hits               0	# Do not skip reference channels
detector_interface.disabled_laben_channel_properties  {bad_precalib}  #only bad precalib channels removed to calculate ok dark rates and reference times
detector_interface.disabled_muon_channel_properties {}
bx_detector_monitor.enable                            0
# trigger
bx_calib_gate.enable                                  0
bx_calib_gate.db_write                                0
# laben 
bx_calib_laben_charge_tt1.enable                      1
bx_calib_laben_charge_tt1.db_write                    1
bx_calib_laben_electronics.enable                     1
bx_calib_laben_electronics.db_write                   1
bx_calib_laben_electronics.check_reference_lg         1
# muon 
bx_calib_muon_electronics.enable                      1
bx_calib_muon_electronics.db_write                    1
bx_calib_muon_pulser.enable                           1
bx_calib_muon_alignment.enable                        1
bx_calib_muon_alignment.db_write                      1
bx_writer.write_tree                                  0
<include low_level>
bx_laben_findcluster.enable			      1
bx_baricentrator.enable				      1
<end>

<config online>		              # DO online echidna: which includes precalibs
<include precalibrations>	      # include precalibrations
bx_reco_framework.max_events         -1 #do not stop after 1500 events as precalibrations do
bx_calib_laben_decoding.monitor_mode  1 #to print status of precalibrations after 1000 events
# detector monitor
bx_detector_monitor.enable            0 # to be enabled when detector monitor is in place
bx_detector_monitor.calibration_mode  0
bx_detector_monitor.disabling_lg      0
bx_detector_monitor.db_write          0
barn_interface.network_send           1 # to be enabled when detector monitor is in place	
bx_omon.enable                        1
bx_writer.directory                   /online
bx_muon_decoder.enable                1 #overwriting the disabling of config precalibrations
bx_laben_findcluster.enable 	      1 # enable clustering, position, calib_monitor at 10Hz
bx_position_reco_mi.enable  	      1
bx_calib_monitor.enable		      1
<end>

<config led_calib>                                 # Used to calibrate the leds themselves in special runs with a PMT in the black box.
<include low_level>                                # Actual PMT calibration occurs within laser_calibrations config together with ID.
bx_reco_framework.require_electronics_calibrations 0
detector_interface.laben                           0
bx_detector_monitor.enable                         0
<end>

<config laser_calibrations>                          # To be run on laser/calibration runs to calibrate ID and OD PMTs
bx_reco_framework.require_electronics_calibrations   0
bx_detector_monitor.enable                           0
detector_interface.disabled_laben_channel_properties {bad_precalib}
detector_interface.disabled_muon_channel_properties {}
bx_laben_decoder.discard_calib_data                  1 # do not use stored calibrations
#laben
bx_calib_laben_time_align.enable                     1 # enable laser calibration modules
bx_calib_laben_charge_peak.enable                    1
bx_calib_laben_time_align.large_drift                0 # not discard calib data in case of large variations
bx_calib_laben_charge_peak.large_drift               0 # changed from 1
bx_calib_laben_time_align.write_calib                1 # enable DB update
bx_calib_laben_charge_peak.write_calib               1
bx_calib_laben_dark_rates.enable                      1
bx_calib_laben_dark_rates.db_write                    1
bx_calib_laben_dark_rates.min_dark_time               0.5
bx_calib_laben_dark_rates.index_trg_type              1010
#muon
bx_calib_muon_time_align.enable                      1 # enable led calibration module
bx_calib_muon_charge_peak.enable                     1 # enable led calibration module
bx_calib_muon_time_align.write_calib_time            1 # enable DB update
bx_calib_muon_charge_peak.write_calib_charge         1 
bx_calib_muon_dark_rates.enable                      1
bx_calib_muon_dark_rates.db_write                    1
<include low_level>                                  # disable everything past decoding stage
bx_laben_findcluster.enable			     1
<end>

<config laser_calibrations_validate>   # to validate laser calibrations
<include laser_calibrations>
bx_laben_decoder.discard_calib_data    0 # use pre-stored calibrations
bx_calib_laben_time_align.write_calib  0 # do not update DB again (already done)
bx_calib_laben_charge_peak.write_calib 0
detector_interface.muon                0 # not implemented for OD yet
<end>

<config simulation>
flight_path.refidx 1.52
bx_baricentrator.first_hits_gate 60
bx_baricentrator.mean_algorithm QT
bx_baricentrator.Q_normalization 1.13
bx_baricentrator.T_normalization 48
bx_baricentrator.T_filter_time 32
bx_baricentrator.QT_normalization 44
bx_baricentrator.QT_filter_time 32
bx_position_reco_dbn.first_hits_gate 60
bx_position_reco_dbn.gauss_sigma { 0.4, 0.8, 1.0, 1.3, 2.0 }
bx_position_reco_dbn.t0_shift { -3, -3.8, -4.1, -4.4, -4.7 }
bx_position_reco_dbn.refidx 1.6
bx_position_reco_mi.refidx 1.7
bx_position_reco_lngs.refidx 1.66
bx_position_reco.refidx 1.56
#bx_pid_shape.first_hits_gate 60
bx_detector_monitor.disabling_lg  0
bx_v1731sys.enable 0 
bx_energy_reco_dbn.enable 0
bx_energy_reco_msk.enable 0
bx_muon_findcluster.enable 0
bx_muon_tracker.enable 0
bx_laben_energy_tracker.enable 0
bx_laben_tof_tracker.enable 0
bx_global_tracker.enable 0
<end>

<config water>
bx_writer.write_laben_raw 1
bx_laben_findcluster.start_threshold 4
bx_laben_findcluster.count_threshold 4
bx_calib_laben_electronics.enable 0
bx_calib_laben_dark_rates.enable 0
<end>

<config noreco>
bx_position_reco_dbn.enable 0
bx_position_reco_mi.enable 0
bx_position_reco_lngs.enable 0
bx_position_reco_msk.enable 0
bx_position_reco.enable 0
bx_energy_reco_mc.enable 0
bx_energy_reco_lik.enable 0
bx_energy_reco_dbn.enable 0
bx_energy_reco_msk.enable 0
bx_splitting_filter.enable 0
bx_pid_alphabeta.enable 0
bx_pid_positron.enable  0
bx_pid_shape.enable 0
bx_detector_monitor.disabling_lg      0
<end>

<config source>
detector_interface.disabled_laben_channel_properties { user, db, bad_precalib, empty, disconnected, bad_pmt_timing, dead_in_neutrino, dead_in_raw, bad_elec_timing, low_gain, high_gain }
bx_position_reco_mi.keep_ratio -1
<end>

<config mach4>
bx_writer.write_laben_decoded 0 
bx_writer.write_laben_clustered 1	#need to comment these two lines out if you
bx_writer.write_laben_rec 1 		#want to use the root file to make ab shapes
bx_writer.write_muon_raw 0 
bx_writer.write_muon_decoded 0 
bx_position_reco.refidx 1.700 
bx_position_reco_dbn.enable 0 
bx_position_reco_msk.enable 0 
bx_position_reco.position_algorithm mach4 
<end>

<config source_simulation>
<include simulation>
detector_interface.disabled_laben_channel_properties { user, bad_precalib, empty, disconnected, bad_pmt_timing, dead_in_neutrino, dead_in_raw, bad_elec_timing, low_gain, high_gain}
bx_position_reco_mi.keep_ratio -1
<end>

<config cngs>
bx_laben_decoder.discard_reference_hits 0
bx_laben_decoder.nhits_threshold 100
bx_detector_monitor.enable 0
bx_dbi.write_enabled 0
<include low_level>
bx_laben_findcluster.enable 1
bx_baricentrator.enable	1
bx_position_reco.position_algorithm baricenter
bx_muon_findcluster.enable 1
bx_muon_tracker.enable 1
bx_laben_energy_tracker.enable 1
bx_laben_tof_tracker.enable 1
bx_global_tracker.enable 1
detector_interface.disabled_laben_channel_properties { user, db, bad_precalib, empty, disconnected, bad_pmt_timing, bad_elec_timing, hot_in_neutrino, low_gain, high_gain }
<end>


<config no_elcalib>
require_electronics_calibrations 0 # require electronics calibrations data
<end>

